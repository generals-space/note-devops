# bridge+vlanå®éªŒ.02.æ•°æ®æµå…¥vid 100

æ¢å¤å¼•è¨€ä¸­çš„å®éªŒç½‘ç»œ, å¼€å¯ bridge çš„ vlan è¿‡æ»¤åŠŸèƒ½.

```
ip netns exec ns03 ip link set dev mybr0 type bridge vlan_filtering 1
```

## ä¸å¸¦ vlan tag çš„æ•°æ®åŒ…, ä¼šè¢« bridge è®¾å¤‡ä¸¢å¼ƒ

åœ¨`ns03`ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤, ä¿®æ”¹ veth31 æ¥å£çš„ vlan tag

```console
$ bridge vlan del dev veth31 vid 1
$ bridge vlan add dev veth31 vid 100
$ bridge vlan show
port	vlan ids
veth31	 100
veth32	 1 PVID Egress Untagged
mybr0	 1 PVID Egress Untagged
```

ç½‘ç»œæ‹“æ‰‘æ²¡å˜, ä»`ns01`ä¸­ping 10.1.1.4å·²ç»ä¸é€šäº†.

æ•°æ®åŒ…æµå‘: veth11 -> veth31 -ğŸš«> mybr0 -> veth32 -> veth22

åœ¨ mybr0 å¤„æŠ“åŒ…, æ²¡æœ‰æ•°æ®å‡ºç°, è¯´æ˜ä¸å¸¦ vlan tag çš„æ•°æ®åŒ…è¢«ä¸¢å¼ƒäº†.

## å¸¦æœ‰ vlan tag ä¸” id ä¸ä¸º 100 (ä¸è¯¥ bridge ç«¯å£ä¸åŒ¹é…)çš„æ•°æ®åŒ…, ä¹Ÿä¼šè¢« bridge è®¾å¤‡ä¸¢å¼ƒ

ä» veth11 è®¾å¤‡ä¸Šæ·»åŠ  vid 1 çš„ vlan è®¾å¤‡.

```
ip netns exec ns01 ip link add link veth11 name veth11.1 type vlan id 1
ip netns exec ns01 ip addr del 10.1.1.3/24 dev veth11
ip netns exec ns01 ip r flush dev veth11
ip netns exec ns01 ip addr add 10.1.1.3/24 dev veth11.1
ip netns exec ns01 ip link set veth11.1 up
```

è¿™æ ·å‘å‡ºçš„æ•°æ®åŒ…å°±ä¼šå¸¦æœ‰ vid 1 çš„ vlan tag äº†.

æ­¤æ—¶ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹

```
+-------------------------------+-------------------------------------------------------+
|              netns1           |                  netns3                 |   netns2    |
|  10.1.1.1/24                  |                                         | 10.1.1.2/24 |
|  +----------+      +-------+  |  +-------+     +-------+     +-------+  |  +-------+  |
|  | veth11.1 â”œâ”€â”€â”€â”€â”€â”€â”¤ veth11|  |  |veth31 | <-> | mybr0 | <-> | veth32|  |  | veth22|  |
|  +----------+      +---â†‘---+  |  +---â†‘---+     +-------+     +----â†‘--+  |  +--â†‘----+  |
|      vlan              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       |
+-------------------------------+-----------------------------------------+-------------+
```

æ•°æ®åŒ…æµå‘: veth11 -> veth31 -ğŸš«> mybr0 -> veth32 -> veth22

## åªæœ‰å¸¦æœ‰ vlan tag, ä¸” id ä¸º 100 æ•°æ®åŒ…, æ‰ä¼šè¢« bridge æ¥æ”¶

```
ip netns exec ns01 ip link del veth11.1

ip netns exec ns01 ip link add link veth11 name veth11.100 type vlan id 100
ip netns exec ns01 ip addr add 10.1.1.3/24 dev veth11.100
ip netns exec ns01 ip link set veth11.100 up
```

æ­¤æ—¶ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹

```
+-------------------------------+-------------------------------------------------------+
|              netns1           |                  netns3                 |   netns2    |
|  10.1.1.1/24                  |                                         | 10.1.1.2/24 |
|  +----------+      +-------+  |  +-------+     +-------+     +-------+  |  +-------+  |
|  |veth11.100â”œâ”€â”€â”€â”€â”€â”€â”¤ veth11|  |  |veth31 | <-> | mybr0 | <-> | veth32|  |  | veth22|  |
|  +----------+      +---â†‘---+  |  +---â†‘---+     +-------+     +----â†‘--+  |  +--â†‘----+  |
|      vlan              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       |
+-------------------------------+-----------------------------------------+-------------+
```

å†æ¬¡ping, è™½ç„¶è¿˜æ˜¯ ping ä¸é€š, ä¸è¿‡ bridge ä¸Šå·²ç»å¯ä»¥æŠ“åˆ°æ•°æ®äº†.

æ•°æ®åŒ…æµå‘: veth11 -> veth31 -> mybr0 -ğŸš«> veth32 -> veth22

